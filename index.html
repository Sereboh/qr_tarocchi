<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mystic Tarot</title>
<style>
  :root{
    --fg:#f4e7c2;
    --bg1:#130f22;
    --bg2:#000;
    --card-w:110px;
    --card-h:160px;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family: Georgia,serif;
    color:var(--fg);
    background: radial-gradient(circle at top,var(--bg1),var(--bg2));
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }

  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px}
  h1{margin:0;font-size:20px;letter-spacing:2px}

  .controls{display:flex;gap:8px;align-items:center}
  button.ctrl{
    background:rgba(34,25,51,0.55);
    color:var(--fg);
    border:1px solid rgba(147,116,201,0.22);
    padding:8px 12px;border-radius:10px;
    cursor:pointer;font-size:14px;
    backdrop-filter: blur(4px);
  }

  #deck{
    position:relative;
    width:100%;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    perspective:1400px;
    -webkit-tap-highlight-color: transparent;
  }

  .card{
    position:absolute;
    width:var(--card-w);
    height:var(--card-h);
    border-radius:10px;
    background-size:cover;
    background-position:center;
    transform-origin:center bottom;
    cursor:pointer;
    opacity:0;
    transition: box-shadow .18s ease, transform .72s cubic-bezier(.2,.9,.3,1), left .72s ease, top .72s ease, opacity .28s;
    will-change: transform, left, top, opacity;
    box-shadow: 0 14px 36px rgba(0,0,0,0.6);
    border:2px solid rgba(0,0,0,0.12);
    overflow:hidden;
  }

  .card.glow{ filter: drop-shadow(0 0 14px rgba(147,116,201,0.32)); }

  .card:hover{
    transform: translateY(-10px) scale(1.06);
    z-index:3000;
    box-shadow: 0 28px 56px rgba(0,0,0,0.7);
  }

  .stack-card{ transition: transform .9s ease, opacity .5s; }
  .stack-pulse{ animation: breathe 2.6s infinite; transform-origin:center; }
  @keyframes breathe{
    0%{ transform: translateX(-50%) translateY(-50%) rotate(0deg) scale(1) }
    50%{ transform: translateX(-50%) translateY(-54%) rotate(0deg) scale(1.022) }
    100%{ transform: translateX(-50%) translateY(-50%) rotate(0deg) scale(1) }
  }

  .shake{ animation: shakeit .42s cubic-bezier(.4,0,.2,1); transform-origin:center; }
  @keyframes shakeit{
    0%{ transform: translateX(-50%) rotate(0deg) }
    25%{ transform: translateX(calc(-50% + 6px)) rotate(-1.6deg) }
    50%{ transform: translateX(calc(-50% - 6px)) rotate(1.6deg) }
    75%{ transform: translateX(calc(-50% + 3px)) rotate(-0.8deg) }
    100%{ transform: translateX(-50%) rotate(0deg) }
  }

  #overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.8));
    opacity:0;pointer-events:none;transition:opacity .28s ease;
    padding:18px;
  }
  #overlay.show{ opacity:1; pointer-events:auto; }

  #box{
    width:100%;max-width:520px;background:linear-gradient(180deg,#0f0f10,#111111);
    border-radius:12px;padding:18px;box-shadow:0 20px 66px rgba(0,0,0,0.7);
    max-height:92vh;overflow:auto;transform-origin:center;transition:transform .32s cubic-bezier(.2,.9,.3,1);
  }
  #box img{width:100%;border-radius:8px;display:block}
  #title{margin-top:12px;font-size:20px}
  #desc{margin-top:10px;line-height:1.45;color:#e8dfc6;text-align:justify}
  #restart{margin-top:14px;padding:10px 14px;border-radius:10px;background:#2b1f3a;border:1px solid rgba(147,116,201,0.18);color:var(--fg);cursor:pointer}

  @media (max-width:640px){
    :root{ --card-w:88px; --card-h:128px }
    header{padding:8px}
    #box{max-width:94%}
  }
</style>
</head>
<body>
<header>
  <h1 id="titleMain">Clicca il mazzo per aprire</h1>
  <div class="controls">
    <button class="ctrl" id="musicBtn">ðŸŽµ Play</button>
    <button class="ctrl" id="langIt">IT</button>
    <button class="ctrl" id="langEn">EN</button>
  </div>
</header>

<div id="deck" aria-label="Mazzo di carte"></div>

<div id="overlay" onclick="closeCard()">
  <div id="box" onclick="event.stopPropagation()">
    <img id="imgBig" alt="">
    <div id="title"></div>
    <div id="desc"></div>
    <div style="text-align:center">
      <button id="restart">Torna al mazzo</button>
    </div>
  </div>
</div>

<audio id="bgmusic" loop preload="none"><source src="music.mp3" type="audio/mpeg"></audio>

<script>
/* DATA */
const namesIT = [
"Il Matto / Masaniello","Il Mago / Virgilio","La Papessa / Sibilla Cumana",
"Lâ€™Imperatrice / Maria Carolina","Lâ€™Imperatore / Federico II","Il Papa / San Gennaro",
"Gli Amanti / Sebeto e Megara","Il Carro / Maradona","La Forza / Femminiello",
"Lâ€™Eremita / Munaciello","La Ruota della Fortuna / Ruota degli Esposti",
"La Giustizia / Maddalena Cerasuolo","Lâ€™Appeso / Maria la Rossa",
"La Morte / Anime Pezzentelle","La Temperanza / Partenope","Il Diavolo / Mammone",
"La Torre / Maschio Angioino","La Stella / Bella â€™Mbriana","La Luna / Janare",
"Il Sole / Pulcinella","Il Giudizio / Vesuvio","Il Mondo / Artisti Napoletani"
];

const namesEN = [
"The Fool","The Magician","The High Priestess","The Empress","The Emperor",
"The Hierophant","The Lovers","The Chariot","Strength","The Hermit",
"Wheel of Fortune","Justice","The Hanged Man","Death","Temperance",
"The Devil","The Tower","The Star","The Moon","The Sun","Judgement","The World"
];

const descIT = [
"Il Matto / Masaniello â€” La carta del Matto rappresenta la spontaneitÃ , lâ€™ingenuitÃ  e la libertÃ ...",
"Il Mago / Virgilio â€” La carta del Mago rappresenta lâ€™abilitÃ  e il potere creativo...",
"â€¦", // Inserisci tutte le descrizioni complete
];

const descEN = [
"The Fool / Masaniello â€” The Fool stands for spontaneity and freedom...",
"The Magician / Virgilio â€” The Magician symbolizes skill and creative power...",
"â€¦", // Inserisci tutte le descrizioni complete
];

/* ELEMENTS & STATE */
const deckEl = document.getElementById('deck');
const overlay = document.getElementById('overlay');
const imgBig = document.getElementById('imgBig');
const titleEl = document.getElementById('title');
const descEl = document.getElementById('desc');
const titleMain = document.getElementById('titleMain');
const musicBtn = document.getElementById('musicBtn');
const langIt = document.getElementById('langIt');
const langEn = document.getElementById('langEn');
const restartBtn = document.getElementById('restart');
const bg = document.getElementById('bgmusic');

let cards = [];
let lang = 'it';
let opened = false;

function slugFromName(name){
  let base = name.split('/')[0].trim().toLowerCase();
  base = base.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  base = base.replace(/[^a-z0-9]+/g,'');
  return base;
}
function getCardW(){ return parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w')) || 110; }
function getCardH(){ return parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-h')) || 160; }

function createClosedDeck(){
  deckEl.innerHTML='';
  cards=[];
  opened=false;
  titleMain.innerText = (lang==='it') ? 'Clicca il mazzo per aprire' : 'Tap the deck to open';

  for(let i=0;i<6;i++){
    const el = document.createElement('div');
    el.className = 'card stack-card stack-pulse';
    el.style.left = '50%';
    el.style.top  = '50%';
    el.style.transform = `translateX(-50%) translateY(-50%) rotate(${(i-3)*1.2}deg)`;
    el.style.backgroundImage = `url("back.jpg")`;
    el.style.opacity = 1 - i*0.06;
    el.style.zIndex = 200 + i;
    if(i===5){
      el.style.cursor='pointer';
      el.addEventListener('click', e=>{ e.stopPropagation(); openDeck(); });
    } else {
      el.style.pointerEvents='none';
    }
    deckEl.appendChild(el);
    cards.push(el);
  }
}

function openDeck(){
  if(opened) return;
  opened = true;

  const shaker = document.createElement('div');
  shaker.style.position='absolute';
  shaker.style.left='50%'; shaker.style.top='50%';
  shaker.style.width='0'; shaker.style.height='0';
  shaker.className='shake';
  deckEl.appendChild(shaker);

  setTimeout(()=> {
    if(shaker.parentNode) shaker.parentNode.removeChild(shaker);
    spawnDeck();
  },420);
}

function spawnDeck(){
  deckEl.innerHTML='';
  cards=[];
  const n = 22;
  const cw = getCardW(), ch = getCardH();
  for(let i=0;i<n;i++){
    const c = document.createElement('div');
    c.className='card';
    c.dataset.index = i;
    c.style.left = `calc(50% - ${cw/2}px)`;
    c.style.top  = `calc(50% - ${ch/2}px)`;
    c.style.transform = `rotate(${(Math.random()-0.5)*8}deg)`;
    c.style.backgroundImage = `url("back.jpg")`;
    c.style.opacity = 1;
    c.style.zIndex = 1000 + i;
    c.addEventListener('click', e=>{ e.stopPropagation(); onCardClick(c); });
    deckEl.appendChild(c);
    cards.push(c);
  }
  setTimeout(()=> fanOpen(), 90);
}

/* FAN centrato perfettamente */
function fanOpen(){
  const n = cards.length;
  const cw = getCardW(), ch = getCardH();
  const pivotX = window.innerWidth / 2;
  const pivotY = window.innerHeight / 2;

  const leftAngleDeg = -52;
  const rightAngleDeg = 20;
  const totalAngle = rightAngleDeg - leftAngleDeg;

  const mid = (n-1)/2;
  const order = Array.from({length:n}, (_,i)=>i).sort((a,b)=>Math.abs(a-mid)-Math.abs(b-mid));

  const radius = Math.max(window.innerWidth * 0.48, 280);
  const positions = [];

  for(let i=0;i<n;i++){
    const t = i/(n-1);
    const eased = t<0.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;
    const angleDeg = leftAngleDeg + eased*totalAngle;
    const angleRad = angleDeg * Math.PI / 180;
    const px = pivotX + radius*Math.sin(angleRad);
    const py = pivotY - radius*Math.cos(angleRad);
    const centerOffset = Math.cos((t-0.5)*Math.PI)*6;
    const finalX = px - cw/2;
    const finalY = py - ch/2 + centerOffset;
    const scale = 1 + 0.18*Math.cos((t-0.5)*Math.PI);
    positions.push({x:finalX, y:finalY, angle:angleDeg, scale});
  }

  order.forEach((i,seq)=>{
    const pos = positions[i];
    const delay = seq*40 + Math.random()*30;
    setTimeout(()=>{
      const c = cards[i];
      c.style.left = pos.x+'px';
      c.style.top = pos.y+'px';
      c.style.opacity = 1;
      c.style.transform = `rotate(${pos.angle}deg) scale(${pos.scale})`;
      if(Math.abs(i-mid)<3) c.classList.add('glow');
      c.style.zIndex = 3000 - Math.round(Math.abs(i-mid));
    }, delay);
  });
}

function onCardClick(card){
  if(!opened) return;
  const idx = parseInt(card.dataset.index,10);

  cards.forEach(c=>{
    if(c!==card){
      c.style.transition = 'transform .35s ease, opacity .35s';
      c.style.opacity=0;
      try{c.style.transform=c.style.transform+' scale(0.6)';}catch(e){}
    } else {
      const slug = slugFromName(namesIT[idx]);
      c.style.transition='transform .48s cubic-bezier(.2,.9,.3,1)';
      c.style.transform=c.style.transform+' rotateY(180deg) scale(1.02)';
      setTimeout(()=>{c.style.backgroundImage=`url("img/${idx}_${slug}.jpg")`},240);
    }
  });

  setTimeout(()=>openOverlay(idx),520);
}

function openOverlay(i){
  overlay.classList.add('show');
  titleEl.innerText = (lang==='it')?namesIT[i]:namesEN[i];
  descEl.innerText  = (lang==='it')?descIT[i]:descEN[i];
  const slug = slugFromName(namesIT[i]);
  imgBig.src = `img/${i}_${slug}.jpg`;
  imgBig.alt = (lang==='it')?namesIT[i]:namesEN[i];
}

function closeCard(){ overlay.classList.remove('show'); }
function restart(){ closeCard(); setTimeout(()=>createClosedDeck(),300); }

musicBtn.addEventListener('click', ()=>{
  if(bg.paused){ bg.play().catch(()=>{}); musicBtn.innerText='â¸ Pause'; }
  else{ bg.pause(); musicBtn.innerText='ðŸŽµ Play'; }
});

langIt.addEventListener('click',()=>setLang('it'));
langEn.addEventListener('click',()=>setLang('en'));
function setLang(l){
  lang=l;
  titleMain.innerText=(lang==='it')?'Clicca il mazzo per aprire':'Tap the deck to open';
  if(overlay.classList.contains('show')){
    const src=imgBig.src||'';
    const m=src.match(/\/(\d+)_/);
    if(m){ const i=parseInt(m[1],10); titleEl.innerText=(lang==='it')?namesIT[i]:namesEN[i]; descEl.innerText=(lang==='it')?descIT[i]:descEN[i]; }
  }
}

createClosedDeck();
restartBtn.addEventListener('click', (e)=>{e.stopPropagation();restart();});
overlay.addEventListener('click', (e)=>{if(e.target===overlay) closeCard();});
window.addEventListener('resize', ()=>{ if(opened && cards.length){ fanOpen(); }});
</script>
</body>
</html>
